---
title: "Fleet Revenue and Expense Dashboard"
date: 2024-03-08 09:47:32 -0500
categories: [Analytics, Visualization]
tags: [sql, tableau, fleet, finance, postgres, psql, logistics, cost-analysis, docker]
image:
  path: /assets/img/projects/FleetFinances/Dashboard.png
  alt: Fleet Revenue and Expense Tracker
---

A visualizaiton of key fleet management metrics.

> <a href="https://public.tableau.com/views/FleetRevenueExpenseTracker/Dashboard?:language=en-US&publish=yes&:sid=&:display_count=n&:origin=viz_share_link" target="_blank">__Click here to open the interactive Tableau dashboard!__</a>
{: .prompt-info }

## Purpose

This was a quick dashboard put together to visualize some fleet management metrics. I wanted to visualize the following metrics:

- Net Income per Kilometer
- Fuel Cost per Kilometer
- Visualized cost metrics by cost type
- Visualized revenue, costs, & profit over time by categorization of truck

## Data Preparation

This dataset was pulled from [Kaggle](https://www.kaggle.com/datasets/syednaveed05/logistics-fleet-data), and includes 5 total tables in a Dimension/Fact schema. Here is an entity relationship diagram that describes the dataset:

![Desktop View](/assets/img/projects/FleetFinances/diagram.png){: width="1893" height="1196" }

#### Creating the Database

```zsh
docker exec -it postgres-container psql -U postgres
```

```sql
postgres=# CREATE DATABASE fleetDW WITH OWNER 'fleetowner';
postgres-# \q
```

```zsh
docker cp ./dcustomers.csv postgres-container:/dcustomers.csv
docker cp ./ddrivers.csv postgres-container:/ddrivers.csv
docker cp ./dvehicles.csv postgres-container:/dvehicles.csv
docker cp ./fcosts.csv postgres-container:/fcosts.csv
docker cp ./ffreight.csv postgres-container:/ffreight.csv
docker exec -it postgres-container psql -U trees fleetdw;
```

#### Creating the Tables and Constraints

```sql
CREATE TABLE dCustomers (
    CustomerID INTEGER NOT NULL,
    City TEXT,
    State TEXT,
    Latitude NUMERIC,
    Longitude NUMERIC,
    UNIQUE (CustomerID)
);

CREATE TABLE dDrivers (
    DriverID INTEGER NOT NULL,
    Driver TEXT,
    UNIQUE (DriverID)
);

CREATE TABLE dVehicles (
    VehicleID INTEGER NOT NULL,
    Plate TEXT,
    Brand TEXT,
    TruckType TEXT,
    TrailersType TEXT,
    VehicleYear SMALLINT,
    UNIQUE (VehicleID)
);

CREATE TABLE fCosts (
    CostDate DATE,
    TruckID INTEGER NOT NULL,
    DriveID INTEGER NOT NULL,
    KMTraveled INTEGER,
    Liters NUMERIC,
    Fuel NUMERIC,
    Maintenance NUMERIC,
    FixedCosts NUMERIC,
    CONSTRAINT fk_costs_vehicles
        FOREIGN KEY(TruckID)
            REFERENCES dVehicles(VehicleID),
    CONSTRAINT fk_costs_driver
        FOREIGN KEY (DriveID)
            REFERENCES dDrivers(DriverID)
    
);

CREATE TABLE fFreight (
    TripDate DATE,
    CustomerID INTEGER NOT NULL,
    TruckID INTEGER NOT NULL,
    InvoiceNumber INTEGER NOT NULL,
    FreightID TEXT NOT NULL,
    City TEXT,
    NetRevenue NUMERIC,
    WeightkG NUMERIC,
    WeightCubic NUMERIC,
    GoodsValue NUMERIC,
    CONSTRAINT fk_freight_customer
        FOREIGN KEY (CustomerID)
            REFERENCES dCustomers(CustomerID),
    CONSTRAINT fk_freight_vehicle
        FOREIGN KEY (TruckID)
            REFERENCES dVehicles(VehicleID)
);
```

#### Importing the Data

```sql
\copy dCustomers(CustomerID, City, State, Latitude, Longitude) FROM 'dcustomers.csv' WITH DELIMITER ',' CSV HEADER;
\copy dDrivers(DriverID, Driver) FROM 'ddrivers.csv' WITH DELIMITER ',' CSV HEADER;
\copy dVehicles(VehicleID, Plate, Brand, TruckType, TrailersType, VehicleYear) FROM 'dvehicles.csv' WITH DELIMITER ',' CSV HEADER;
\copy fCosts(CostDate, TruckID, DriveID, KMTraveled, Liters, Fuel, Maintenance, FixedCosts) FROM 'fcosts.csv' WITH DELIMITER ',' CSV HEADER;
\copy fFreight(TripDate, CustomerID, TruckID, InvoiceNumber, FreightID, City, NetRevenue, WeightkG, WeightCubic, GoodsValue) FROM 'ffreight.csv' WITH DELIMITER ',' CSV HEADER;
```

We're ready to query now!

### Aggregating for Tableau

```sql
--The CostsPerMonth CTE aggregates the KM traveled adn the fuel, maintenance, and fixed costs by month for each truck type.
WITH CostsPerMonth AS (
SELECT
	DATE_TRUNC('Month',fCosts.CostDate)::DATE AS CostMonth,
	dVehicles.TruckType,
	SUM(fCosts.Fuel) AS TotalFuel,
	SUM(fCosts.Maintenance) AS TotalMaintenance,
	SUM(fCosts.FixedCosts) AS TotalFixedCosts,
	SUM(fCosts.KMTraveled) AS TotalKM,
	SUM(fCosts.Fuel + fCosts.Maintenance + fCosts.FixedCosts) AS TotalCost
FROM fCosts
LEFT JOIN dVehicles 
    ON fCosts.TruckID = dVehicles.VehicleID
GROUP BY CostMonth, dVehicles.TruckType
HAVING SUM(fCosts.KMTraveled) > 0
),

--The FreightPerMonth CTE aggregates the revenue generated by month for each truck type.
FreightPerMonth AS (
SELECT
	DATE_TRUNC('Month',fFreight.TripDate)::DATE AS FreightMonth,
	dVehicles.TruckType,
	SUM(fFreight.NetRevenue) AS TotalRevenue
FROM  fFreight
LEFT JOIN dVehicles 
    ON fFreight.TruckID = dVehicles.VehicleID
GROUP BY FreightMonth, dVehicles.TruckType
)

SELECT
	FreightMonth,
	FreightPerMonth.TruckType,
	TotalRevenue,
	TotalFuel,
	TotalMaintenance,
	TotalFixedCosts,
	TotalKM,
	TotalCost,
	TotalFuel / NULLIF(TotalKM, 0) AS FuelCostPerKM, --Fuel costs divided by KM traveled.
	(TotalRevenue - TotalCost) / NULLIF(TotalKM, 0) AS MarginPerKM, --Net income divided by KM traveled.
	TotalCost / NULLIF(TotalKM, 0) AS TotalCostPerKM --Costs divided by KM traveled.
FROM FreightPerMonth
LEFT JOIN CostsPerMonth 
    ON FreightPerMonth.TruckType = CostsPerMonth.TruckType 
    AND FreightMonth = CostMonth
ORDER BY CostMonth ASC;
```

The output of this aggregation is fed into Tableau to create the Fleet Revenue & Expense Tracker dashboard!

> <a href="https://public.tableau.com/views/FleetRevenueExpenseTracker/Dashboard?:language=en-US&publish=yes&:sid=&:display_count=n&:origin=viz_share_link" target="_blank">__Click here to open the interactive Tableau dashboard!__</a>
{: .prompt-info }